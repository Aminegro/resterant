/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ Ù…Ù„Ùƒ Ø§Ù„Ø·Ø§Ø¨ÙˆÙ† - Backend Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (Ø§Ù„Ø¹Ù‚Ù„)
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙˆØ³ÙŠØ· Ø§Ù„Ø¢Ù…Ù† Ø¨ÙŠÙ† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆÙ…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„
 * 
 * Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ§Øª:
 * 1. Ø­Ù…Ø§ÙŠØ© Ù…ÙØªØ§Ø­ OpenAI API
 * 2. Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
 * 3. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
 * 4. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ÙˆÙ‚Ø¹ÙŠÙ†
 * 5. Rate Limiting Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ø³Ø§Ø¡Ø©
 * 6. Ù…Ø³Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

const express = require('express');
const cors = require('cors');
const rateLimit = require('express-rate-limit');

const app = express();
const PORT = process.env.PORT || 3000;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© (Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const OPENAI_API_KEY = process.env.OPENAI_API_KEY || 'YOUR_API_KEY_HERE';

// ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ù…ÙØªØ§Ø­
if (!OPENAI_API_KEY) {
    console.warn('âš ï¸  ØªØ­Ø°ÙŠØ±: Ù…ÙØªØ§Ø­ OpenAI ØºÙŠØ± Ù…ÙØ¹Ø¯! Ø£Ø¶ÙÙ‡ ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ›¡ï¸ Middleware
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// CORS - Ø§Ù„Ø³Ù…Ø§Ø­ Ù„ÙƒÙ„Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ÙŠÙ†
app.use(cors({
    origin: '*', // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø­Ø¯Ø¯ Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
    methods: ['GET', 'POST', 'PATCH', 'DELETE'],
    allowedHeaders: ['Content-Type']
}));

app.use(express.json());

// Rate Limiting - Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ø³Ø§Ø¡Ø©
const chatLimiter = rateLimit({
    windowMs: 60 * 1000, // Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©
    max: 20, // 20 Ø·Ù„Ø¨ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
    message: {
        success: false,
        error: 'Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©',
        errorCode: 'RATE_LIMIT_EXCEEDED'
    }
});

const ordersLimiter = rateLimit({
    windowMs: 60 * 1000,
    max: 60,
    message: { success: false, error: 'Rate limit exceeded' }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¦ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const db = {
    orders: [],
    counter: 1000,
    lastCleanup: new Date().toDateString()
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ§¹ ØªÙ†Ø¸ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠÙˆÙ…ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function autoCleanup() {
    const today = new Date().toDateString();

    if (today !== db.lastCleanup) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        yesterday.setHours(0, 0, 0, 0);

        const before = db.orders.length;
        db.orders = db.orders.filter(o => new Date(o.createdAt) >= yesterday);

        if (before !== db.orders.length) {
            console.log(`ğŸ§¹ ØªÙ†Ø¸ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ø­Ø°Ù ${before - db.orders.length} Ø·Ù„Ø¨ Ù‚Ø¯ÙŠÙ…`);
        }
        db.lastCleanup = today;
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙƒÙ„ Ø³Ø§Ø¹Ø©
setInterval(autoCleanup, 60 * 60 * 1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ• Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¹Ø© 5:00 ÙØ¬Ø±Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù‚Ø¯Ø³
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let lastCleanupDate = '';

function dailyCleanupAt5AM() {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù‚Ø¯Ø³
    const jerusalemTime = new Date().toLocaleString('en-US', { timeZone: 'Asia/Jerusalem' });
    const now = new Date(jerusalemTime);

    const hours = now.getHours();
    const minutes = now.getMinutes();
    const todayDate = now.toDateString();

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø³Ø§Ø¹Ø© 5:00-5:01 ÙØ¬Ø±Ø§Ù‹ ÙˆÙ„Ù… ÙŠØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ…
    if (hours === 5 && minutes < 2 && lastCleanupDate !== todayDate) {
        const deletedCount = db.orders.length;
        db.orders = [];
        db.counter = 1000;
        lastCleanupDate = todayDate;

        console.log('');
        console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        console.log('â•‘  ğŸ§¹ Ù…Ø³Ø­ ÙŠÙˆÙ…ÙŠ - Ø§Ù„Ø³Ø§Ø¹Ø© 5:00 ÙØ¬Ø±Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù‚Ø¯Ø³              â•‘');
        console.log(`â•‘  ğŸ“Š ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${deletedCount} Ø·Ù„Ø¨                         â•‘`);
        console.log('â•‘  âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯                                  â•‘');
        console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('');
    }
}

// ÙØ­Øµ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø³Ø§Ø¹Ø© 5 ÙØ¬Ø±Ø§Ù‹
setInterval(dailyCleanupAt5AM, 30 * 1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¤– System Prompt Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `# ÙˆÙƒÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø¹Ù… Ù…Ù„Ùƒ Ø§Ù„Ø·Ø§Ø¨ÙˆÙ†

## Ù‡ÙˆÙŠØªÙƒ
Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø¹Ù… "Ù…Ù„Ùƒ Ø§Ù„Ø·Ø§Ø¨ÙˆÙ†" ÙÙŠ Ø§Ù„Ø¹ÙŠØ²Ø±ÙŠØ©. ØªØ³ØªÙ‚Ø¨Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ©.

## Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…
- Ø§Ù„Ø§Ø³Ù…: Ù…Ù„Ùƒ Ø§Ù„Ø·Ø§Ø¨ÙˆÙ†
- Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø§Ù„Ø¹ÙŠØ²Ø±ÙŠØ© - Ø¯ÙˆØ§Ø± ÙˆØ§Ø¯ÙŠ Ø§Ù„Ù†Ø§Ø±
- Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 8:00 ØµØ¨Ø§Ø­Ø§Ù‹ - 2:00 Ø¨Ø¹Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ (ÙŠÙˆÙ…ÙŠØ§Ù‹)
- ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ±: 7-10 Ø¯Ù‚ÙŠÙ‚Ø©
- Ø§Ù„ØªÙˆØµÙŠÙ„: Ù…ØªÙˆÙØ± Ù„Ù„Ø¹ÙŠØ²Ø±ÙŠØ© ÙˆØ§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø¬Ø§ÙˆØ±Ø©
- Ø§Ù„Ø¯ÙØ¹: ÙƒØ§Ø´ Ø£Ùˆ ÙÙŠØ²Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ù„ ÙÙ‚Ø·

## Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø³Ù„ÙˆÙƒ
1. ØªØ­Ø¯Ø« Ø¨Ù„Ù‡Ø¬Ø© ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ© Ø¨Ø³ÙŠØ·Ø© ÙˆÙˆØ¯ÙˆØ¯Ø©
2. ÙƒÙ† Ù…Ø®ØªØµØ±Ø§Ù‹ - Ù„Ø§ ØªÙƒØªØ¨ Ø±Ø³Ø§Ø¦Ù„ Ø·ÙˆÙŠÙ„Ø©
3. Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒØ§Ù…Ù„Ø© - Ø§Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
4. Ø§Ø³ØªØ®Ø¯Ù… Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø§Ø«Ù†ÙŠÙ† ÙÙ‚Ø·
5. Ù„Ø§ ØªØ®ØªØ±Ø¹ Ø£ØµÙ†Ø§Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ„Ø§ ØªØºÙŠØ± Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
6. Ø§Ø¬Ù…Ø¹: Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ø·Ù„Ø¨ + Ø§Ù„Ù…ÙƒØ§Ù† (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ù„ Ø£Ùˆ Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©)

## Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ - ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¤ÙƒØ¯ Ø§Ù„Ø²Ø¨ÙˆÙ† Ø·Ù„Ø¨Ù‡ (ÙŠÙ‚ÙˆÙ„ "Ù†Ø¹Ù…" Ø£Ùˆ "ØªØ£ÙƒÙŠØ¯" Ø£Ùˆ Ø£ÙŠ Ù…ÙˆØ§ÙÙ‚Ø©)ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªØ¶ÙŠÙ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø±Ø¯Ùƒ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø§Ù„Ø¶Ø¨Ø·:

[ORDER_DATA]
{"customer":"Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†","items":"Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©","total":Ø§Ù„Ù…Ø¨Ù„Øº_Ø±Ù‚Ù…,"location":"Ø§Ù„Ù…ÙƒØ§Ù†"}
[/ORDER_DATA]

Ù…Ø«Ø§Ù„:
[ORDER_DATA]
{"customer":"Ø£Ø­Ù…Ø¯","items":"Ø¨ÙŠØªØ²Ø§ Ø§Ù„Ø·Ø§Ø¨ÙˆÙ†Ã—2, Ø¨ÙŠØ¶ Ù…Ø¹ Ø¬Ø¨Ù†Ø©Ã—1","total":55,"location":"Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ù„"}
[/ORDER_DATA]

## Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©

### Ø§Ù„Ø¨ÙŠØªØ²Ø§
- Ø¨ÙŠØªØ²Ø§ Ø§Ù„Ø·Ø§Ø¨ÙˆÙ†: 20 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ø¨Ø§Ù„Ø¬Ø¨Ù†Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡: 23 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ ØªÙˆÙ†Ø§: 25 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ø³ØªÙŠÙƒ Ø¯Ø¬Ø§Ø¬: 30 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ø³Ù„Ø§Ù…ÙŠ: 25 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ù…ÙƒØ³ Ø¬Ø¨Ù†Ø©: 22 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ù…ÙƒØ³ÙŠÙƒÙŠ Ø­Ø§Ø±: 30 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ù†Ù‚Ø§Ù†Ù‚: 23 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ø¹ÙŠÙ…Ùƒ Ø®Ø¶Ø§Ø±: 25 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ø¹ÙŠÙ…Ùƒ Ø³ØªÙŠÙƒ: 35 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ø¹ÙŠÙ…Ùƒ Ø³Ù„Ø§Ù…ÙŠ: 30 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ø¹ÙŠÙ…Ùƒ Ù…ÙƒØ³ÙŠÙƒÙŠ: 35 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØªØ²Ø§ Ø¹ÙŠÙ…Ùƒ Ù†Ù‚Ø§Ù†Ù‚: 28 Ø´ÙŠÙƒÙ„

### Ø§Ù„Ø¨ÙŠØ¶
- Ø¨ÙŠØ¶ Ø³Ø§Ø¯Ø©: 8 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ø¬Ø¨Ù†Ø© Ø¨ÙŠØ¶Ø§Ø¡: 15 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ø¬Ø¨Ù†Ø© Ø¹ÙŠÙ…Ùƒ: 21 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ø¬Ø¨Ù†Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§: 14 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ø¬Ø¨Ù†Ø© ÙˆÙ†Ù‚Ø§Ù†Ù‚: 17 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ø²ÙŠØªÙˆÙ† ÙˆØ¯Ø±Ø©: 12 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ø³Ø¬Ù‚: 20 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ø³Ø¬Ù‚ ÙˆØ¬Ø¨Ù†Ø©: 22 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ø³Ø¬Ù‚ ÙˆØ¬Ø¨Ù†Ø© Ø¹ÙŠÙ…Ùƒ: 28 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ø³Ø¬Ù‚ ÙˆØ¬Ø¨Ù†Ø© ÙˆÙ†Ù‚Ø§Ù†Ù‚: 28 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ø¹ÙŠÙ…Ùƒ ÙˆÙ†Ù‚Ø§Ù†Ù‚: 23 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ù„Ø­Ù…Ø© Ø¨Ø§Ù„Ø¬Ø¨Ù†Ø©: 25 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ù„Ø­Ù…Ø© Ø·Ø§Ø²Ø¬Ø©: 20 Ø´ÙŠÙƒÙ„
- Ø¨ÙŠØ¶ Ù…Ø¹ Ù†Ù‚Ø§Ù†Ù‚: 13 Ø´ÙŠÙƒÙ„

### Ø§Ù„Ø¬Ø¨Ù†Ø©
- Ø¬Ø¨Ù†Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ù…Ø¹ Ø¨Ù†Ø¯ÙˆØ±Ø©: 18 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ù…Ø¹ Ø­Ø¨Ø© Ø§Ù„Ø¨Ø±ÙƒØ©: 15 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ù…Ø¹ Ø²Ø¹ØªØ± Ø£Ø®Ø¶Ø±: 17 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ù…Ø¹ Ø²ÙŠØª ÙˆØ²Ø¹ØªØ±: 17 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ù…Ø¹ Ø²ÙŠØªÙˆÙ† Ø£Ø®Ø¶Ø±: 17 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ø¹ÙŠÙ…Ùƒ: 23 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ø¹ÙŠÙ…Ùƒ Ù…Ø¹ Ø³ØªÙŠÙƒ Ø¯Ø¬Ø§Ø¬: 30 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ø¹ÙŠÙ…Ùƒ Ù…Ø¹ Ø³Ù„Ø§Ù…ÙŠ: 28 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ø¹ÙŠÙ…Ùƒ Ù…Ø¹ Ù†Ù‚Ø§Ù†Ù‚: 27 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§: 18 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§ Ø¨Ø§Ù„Ø¯Ø¬Ø§Ø¬ Ø§Ù„Ù…ÙƒØ³ÙŠÙƒÙŠ Ø§Ù„Ø­Ø§Ø±: 28 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§ Ù…Ø¹ Ø²ÙŠØªÙˆÙ† Ø£Ø®Ø¶Ø±: 20 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§ Ù…Ø¹ Ø³ØªÙŠÙƒ Ø§Ù„Ø¯Ø¬Ø§Ø¬: 28 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§ Ù…Ø¹ Ø³Ù„Ø§Ù…ÙŠ: 25 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§ Ù…Ø¹ Ù†Ù‚Ø§Ù†Ù‚: 23 Ø´ÙŠÙƒÙ„

### Ø§Ù„Ù„Ø­Ù…Ø© ÙˆØ§Ù„Ø³ÙÙŠØ­Ø©
- Ø³ÙÙŠØ­Ø© Ø¨Ø§Ù„Ø¨Ù†Ø¯ÙˆØ±Ø©: 15 Ø´ÙŠÙƒÙ„
- Ø³ÙÙŠØ­Ø© Ø¨Ø§Ù„Ø·Ø­ÙŠÙ†ÙŠØ©: 15 Ø´ÙŠÙƒÙ„
- Ø³ÙÙŠØ­Ø© Ù…ÙƒØ³: 15 Ø´ÙŠÙƒÙ„
- ÙØ§Ù‡ÙŠØªØ§ Ø¬Ø¨Ù†Ø©: 23 Ø´ÙŠÙƒÙ„
- ÙØ§Ù‡ÙŠØªØ§ Ø¯Ø¬Ø§Ø¬: 23 Ø´ÙŠÙƒÙ„
- ÙƒØ¨Ø¯Ø© Ø¯Ø¬Ø§Ø¬: 20 Ø´ÙŠÙƒÙ„
- Ù„Ø­Ù…Ø© Ø·Ø§Ø²Ø¬Ø©: 25 Ø´ÙŠÙƒÙ„
- Ù…Ø³Ø­Ø¨ Ù…Ø¹ Ø¬Ø¨Ù†Ø©: 25 Ø´ÙŠÙƒÙ„
- Ù…Ø³Ø®Ù† Ø¯Ø¬Ø§Ø¬: 22 Ø´ÙŠÙƒÙ„

### Ø§Ù„ØµÙˆØ§Ù†ÙŠ
- ØµÙˆØ§Ù†ÙŠ ÙƒØ¨ÙŠØ± (Ø´ÙˆÙŠ): 30 Ø´ÙŠÙƒÙ„
- ØµÙˆØ§Ù†ÙŠ ÙƒØ¨ÙŠØ± Ù…Ø¹ Ø®Ø¶Ø§Ø±: 40 Ø´ÙŠÙƒÙ„
- ØµÙˆØ§Ù†ÙŠ ÙˆØ³Ø· (Ø´ÙˆÙŠ): 20 Ø´ÙŠÙƒÙ„
- ØµÙˆØ§Ù†ÙŠ ÙˆØ³Ø· Ù…Ø¹ Ø®Ø¶Ø§Ø±: 30 Ø´ÙŠÙƒÙ„

### Ø§Ù„Ø®Ø¨Ø² ÙˆØ§Ù„Ù…Ù†Ø§Ù‚ÙŠØ´
- Ø®Ø¨Ø² Ø§Ù„Ø·Ø§Ø¨ÙˆÙ†: 1.50 Ø´ÙŠÙƒÙ„
- Ø®Ø¨Ø² Ø´Ø±Ø§Ùƒ: 1 Ø´ÙŠÙƒÙ„
- Ù…Ù†Ø§Ù‚ÙŠØ´ Ø²Ø¹ØªØ±: 7 Ø´ÙŠÙƒÙ„
- 7 Ø·Ø§Ø¨ÙˆÙ†: 10 Ø´ÙŠÙƒÙ„

### Ø§Ù„Ù…Ø¹Ø¬Ù†Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
- Ø¬Ø¨Ù†Ø© Ø¨ÙŠØ¶Ø§Ø¡ ØµØºÙŠØ±: 5 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ù…Ø¹ Ø²Ø¹ØªØ± ØµØºÙŠØ±: 7 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ù…Ø¹ Ø²ÙŠØªÙˆÙ† Ø£Ø®Ø¶Ø± ØµØºÙŠØ±: 6 Ø´ÙŠÙƒÙ„
- Ø¬Ø¨Ù†Ø© Ù…Ø¹ Ù†Ù‚Ø§Ù†Ù‚ ØµØºÙŠØ±: 7 Ø´ÙŠÙƒÙ„
- Ø±ÙŠØ§Ù†Ø© Ù„Ø­Ù…Ø©: 8 Ø´ÙŠÙƒÙ„
- Ø³Ø¨Ø§Ù†Ø®: 6 Ø´ÙŠÙƒÙ„
- Ø¹Ø±Ø§ÙŠØ³: 8 Ø´ÙŠÙƒÙ„
- Ù„ÙØ© Ù…Ø³Ø®Ù†: 8 Ø´ÙŠÙƒÙ„
- Ù…Ø³Ø­Ø¨ Ø¯Ø¬Ø§Ø¬: 10 Ø´ÙŠÙƒÙ„

### Ø§Ù„Ù…Ù‚Ø¨Ù„Ø§Øª
- Ø´ÙŠÙ„ÙŠ Ù…ØªÙˆÙƒ: 3 Ø´ÙŠÙƒÙ„
- ØµÙˆØµ ÙÙ‡ÙŠÙ…: 3 Ø´ÙŠÙƒÙ„
- Ø¹Ù„Ø¨Ø© Ø¨Ø§Ø±Ø¨ÙƒÙŠÙˆ: 3 Ø´ÙŠÙƒÙ„
- Ø¹Ù„Ø¨Ø© Ø²ÙŠØªÙˆÙ†: 2 Ø´ÙŠÙƒÙ„
- Ø¹Ù„Ø¨Ø© Ù„ÙØª ØµØºÙŠØ±: 2 Ø´ÙŠÙƒÙ„
- Ø¹Ù„Ø¨Ø© Ù…Ø®Ù„Ù„ ØµØºÙŠØ±: 2 Ø´ÙŠÙƒÙ„
- ÙÙ„ÙÙ„ Ù…ÙƒØ¨ÙˆØ³ ØµØºÙŠØ±: 2 Ø´ÙŠÙƒÙ„
- Ù†Øµ Ø·Ø¨Ù‚ Ø¨ÙŠØ¶: 10 Ø´ÙŠÙƒÙ„

### Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª
- Ù…Ø§Ø¡ ØµØºÙŠØ±: 2 Ø´ÙŠÙƒÙ„
- Ù…Ø§Ø¡ ÙƒØ¨ÙŠØ±: 3 Ø´ÙŠÙƒÙ„
- ÙƒØ§Ø¨ÙŠ ØµØºÙŠØ±: 3 Ø´ÙŠÙƒÙ„
- Ù„Ø¨Ù† Ø£Ø¨: 3 Ø´ÙŠÙƒÙ„
- Ø¹ØµÙŠØ± ØªØ¨ÙˆØ²ÙŠÙ†Ø§: 4 Ø´ÙŠÙƒÙ„
- ØµÙˆØ¯Ø§: 5 Ø´ÙŠÙƒÙ„
- Ù…Ø´Ø±ÙˆØ¨ ØºØ§Ø²ÙŠ 330: 3 Ø´ÙŠÙƒÙ„
- Ù…Ø´Ø±ÙˆØ¨ ØºØ§Ø²ÙŠ 1.25: 5 Ø´ÙŠÙƒÙ„
- BLUE: 5 Ø´ÙŠÙƒÙ„
- TASCO: 5 Ø´ÙŠÙƒÙ„
- XL: 5 Ø´ÙŠÙƒÙ„
- Ø¨Ø§ÙØ§Ø±ÙŠØ§: 5 Ø´ÙŠÙƒÙ„

## Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø§ØµØ©
- Ø§Ù„ØªÙˆØµÙŠÙ„: "Ù…ØªÙˆÙØ± Ù„Ù„Ø¹ÙŠØ²Ø±ÙŠØ© ÙˆØ§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø¬Ø§ÙˆØ±Ø©"
- Ø§Ù„Ø¯ÙØ¹: "ÙƒØ§Ø´ Ø£Ùˆ ÙÙŠØ²Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ù„"
- Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: "Ù…Ù† 8 Ø§Ù„ØµØ¨Ø­ Ù„Ù€ 2 Ø¨Ø§Ù„Ù„ÙŠÙ„ØŒ ÙƒÙ„ ÙŠÙˆÙ…"
- ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: "Ù„Ù„Ø£Ø³Ù Ù…Ø´ Ù…ØªÙˆÙØ±ØŒ Ø¨Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ [Ø¨Ø¯ÙŠÙ„]"`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”Œ API Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„ - Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * POST /api/chat
 * ÙŠØ³ØªÙ‚Ø¨Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆÙŠØ±Ø¯Ù‡Ø§ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
 */
app.post('/api/chat', chatLimiter, async (req, res) => {
    try {
        const { message, history } = req.body;

        if (!message || typeof message !== 'string') {
            return res.status(400).json({
                success: false,
                error: 'Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø·Ù„ÙˆØ¨Ø©'
            });
        }

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        const messages = [
            { role: 'system', content: SYSTEM_PROMPT },
            ...(history || []).slice(-10).map(msg => ({
                role: msg.role === 'user' ? 'user' : 'assistant',
                content: msg.content
            })),
            { role: 'user', content: message }
        ];

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ OpenAI API
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENAI_API_KEY}`
            },
            body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: messages,
                max_tokens: 500,
                temperature: 0.7
            })
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            console.error('OpenAI Error:', error);

            if (response.status === 429) {
                return res.status(429).json({
                    success: false,
                    reply: 'Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ø´ØºÙˆÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰',
                    error: 'RATE_LIMIT'
                });
            }

            throw new Error('OpenAI API Error');
        }

        const data = await response.json();
        let reply = data.choices[0].message.content;

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
        const orderMatch = reply.match(/\[ORDER_DATA\]([\s\S]*?)\[\/ORDER_DATA\]/);
        let orderId = null;

        if (orderMatch) {
            try {
                const orderData = JSON.parse(orderMatch[1].trim());

                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
                const order = {
                    id: ++db.counter,
                    customerName: orderData.customer || 'Ø¹Ù…ÙŠÙ„',
                    items: orderData.items || '',
                    total: parseFloat(orderData.total) || 0,
                    location: orderData.location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                    status: 'new',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    source: 'AI_Chat'
                };

                db.orders.unshift(order);
                orderId = order.id;

                console.log(`\nğŸ”” Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ #${order.id}`);
                console.log(`   ğŸ‘¤ ${order.customerName}`);
                console.log(`   ğŸ• ${order.items}`);
                console.log(`   ğŸ’° ${order.total} Ø´ÙŠÙƒÙ„`);
                console.log(`   ğŸ“ ${order.location}\n`);

                // Ø¥Ø²Ø§Ù„Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø±Ø¯ ÙˆØ¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨
                reply = reply.replace(/\[ORDER_DATA\][\s\S]*?\[\/ORDER_DATA\]/, '').trim();
                reply += `\n\nğŸ“‹ Ø±Ù‚Ù… Ø·Ù„Ø¨Ùƒ: #${orderId}`;

            } catch (e) {
                console.error('Error parsing order:', e);
            }
        }

        res.json({
            success: true,
            reply: reply,
            orderId: orderId
        });

    } catch (error) {
        console.error('Chat Error:', error);
        res.status(500).json({
            success: false,
            reply: 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­ØµÙ„ Ø®Ø·Ø£. ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ 0523668131',
            error: 'SERVER_ERROR'
        });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¦ API Ù„Ù„Ø·Ù„Ø¨Ø§Øª (Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ - Ø§Ù„Ø¹Ù…Ø§Ù„)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * GET /api/orders
 * Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
 */
app.get('/api/orders', ordersLimiter, (req, res) => {
    autoCleanup();

    const { status } = req.query;
    let orders = [...db.orders];

    if (status && status !== 'all') {
        orders = orders.filter(o => o.status === status);
    }

    res.json({
        success: true,
        count: orders.length,
        orders: orders
    });
});

/**
 * POST /api/orders
 * Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠ (Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ©)
 */
app.post('/api/orders', ordersLimiter, (req, res) => {
    const { customerName, items, total, location, notes } = req.body;

    if (!customerName || !items) {
        return res.status(400).json({
            success: false,
            error: 'Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø·Ù„Ø¨ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†'
        });
    }

    const order = {
        id: ++db.counter,
        customerName: customerName.trim(),
        items: items.trim(),
        total: parseFloat(total) || 0,
        location: location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        notes: notes || '',
        status: 'new',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        source: 'Manual'
    };

    db.orders.unshift(order);

    console.log(`ğŸ“ Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠ Ø¬Ø¯ÙŠØ¯ #${order.id}`);

    res.status(201).json({
        success: true,
        message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨',
        order: order
    });
});

/**
 * GET /api/orders/:id
 * Ø¬Ù„Ø¨ Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø¯
 */
app.get('/api/orders/:id', (req, res) => {
    const order = db.orders.find(o => o.id === parseInt(req.params.id));

    if (!order) {
        return res.status(404).json({
            success: false,
            error: 'Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'
        });
    }

    res.json({ success: true, order });
});

/**
 * PATCH /api/orders/:id
 * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
 */
app.patch('/api/orders/:id', (req, res) => {
    const { status, notes } = req.body;
    const order = db.orders.find(o => o.id === parseInt(req.params.id));

    if (!order) {
        return res.status(404).json({
            success: false,
            error: 'Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'
        });
    }

    const validStatuses = ['new', 'preparing', 'ready', 'delivered', 'cancelled'];

    if (status) {
        if (!validStatuses.includes(status)) {
            return res.status(400).json({
                success: false,
                error: 'Ø­Ø§Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©'
            });
        }
        order.status = status;
        console.log(`ğŸ“ ØªØ­Ø¯ÙŠØ« #${order.id}: ${status}`);
    }

    if (notes !== undefined) {
        order.notes = notes;
    }

    order.updatedAt = new Date().toISOString();

    res.json({ success: true, order });
});

/**
 * DELETE /api/orders/:id
 * Ø­Ø°Ù Ø·Ù„Ø¨
 */
app.delete('/api/orders/:id', (req, res) => {
    const index = db.orders.findIndex(o => o.id === parseInt(req.params.id));

    if (index === -1) {
        return res.status(404).json({
            success: false,
            error: 'Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'
        });
    }

    const deleted = db.orders.splice(index, 1)[0];
    console.log(`ğŸ—‘ï¸ Ø­Ø°Ù #${deleted.id}`);

    res.json({ success: true, message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨' });
});

/**
 * GET /api/stats
 * Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª
 */
app.get('/api/stats', (req, res) => {
    autoCleanup();

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayOrders = db.orders.filter(o => new Date(o.createdAt) >= today);

    res.json({
        success: true,
        stats: {
            total: db.orders.length,
            today: todayOrders.length,
            todayRevenue: todayOrders.reduce((sum, o) => sum + o.total, 0),
            byStatus: {
                new: db.orders.filter(o => o.status === 'new').length,
                preparing: db.orders.filter(o => o.status === 'preparing').length,
                ready: db.orders.filter(o => o.status === 'ready').length,
                delivered: db.orders.filter(o => o.status === 'delivered').length,
                cancelled: db.orders.filter(o => o.status === 'cancelled').length
            }
        }
    });
});

/**
 * GET /api/orders/poll
 * Long polling Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©
 */
let lastKnownId = 1000;
app.get('/api/orders/poll', (req, res) => {
    const since = parseInt(req.query.since) || lastKnownId;
    const newOrders = db.orders.filter(o => o.id > since);

    if (newOrders.length > 0) {
        lastKnownId = Math.max(...newOrders.map(o => o.id));
        res.json({
            hasUpdates: true,
            orders: newOrders,
            lastId: lastKnownId
        });
    } else {
        setTimeout(() => {
            res.json({ hasUpdates: false, lastId: since });
        }, 1000);
    }
});

/**
 * GET /api/health
 * ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±
 */
app.get('/api/health', (req, res) => {
    res.json({
        status: 'ok',
        server: 'Ù…Ù„Ùƒ Ø§Ù„Ø·Ø§Ø¨ÙˆÙ† - Backend',
        version: '2.0.0',
        orders: db.orders.length,
        uptime: Math.floor(process.uptime()) + ' Ø«Ø§Ù†ÙŠØ©'
    });
});

/**
 * DELETE /api/cleanup
 * Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ù„Ù„ØªØ·ÙˆÙŠØ± ÙÙ‚Ø·)
 */
app.delete('/api/cleanup', (req, res) => {
    const count = db.orders.length;
    db.orders = [];
    db.counter = 1000;
    console.log(`ğŸ§¹ ØªÙ… Ù…Ø³Ø­ ${count} Ø·Ù„Ø¨`);
    res.json({ success: true, message: `ØªÙ… Ù…Ø³Ø­ ${count} Ø·Ù„Ø¨` });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
    console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                           â•‘
â•‘   ğŸ”¥  Ù…Ù„Ùƒ Ø§Ù„Ø·Ø§Ø¨ÙˆÙ† - Backend Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ                                      â•‘
â•‘                                                                           â•‘
â•‘   ğŸ“¡ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰: http://localhost:${PORT}                             â•‘
â•‘                                                                           â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â•‘
â•‘                                                                           â•‘
â•‘   ğŸ”Œ APIs Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡):                                         â•‘
â•‘      POST /api/chat         â†’ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ                  â•‘
â•‘                                                                           â•‘
â•‘   ğŸ“¦ APIs Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ù„Ø¹Ù…Ø§Ù„):                                         â•‘
â•‘      GET  /api/orders       â†’ Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª                              â•‘
â•‘      POST /api/orders       â†’ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠ                              â•‘
â•‘      PATCH /api/orders/:id  â†’ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ù„Ø¨                              â•‘
â•‘      DELETE /api/orders/:id â†’ Ø­Ø°Ù Ø·Ù„Ø¨                                     â•‘
â•‘      GET  /api/stats        â†’ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª                                  â•‘
â•‘      GET  /api/orders/poll  â†’ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±ÙŠØ©                               â•‘
â•‘                                                                           â•‘
â•‘   â¤ï¸  GET /api/health        â†’ ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±                             â•‘
â•‘                                                                           â•‘
â•‘   Ø¬Ø§Ù‡Ø² Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ÙŠÙ†! ğŸš€                                                 â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `);
});

module.exports = app;
