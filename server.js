/**
 * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 * ๐ฅ ููู ุงูุทุงุจูู - Backend ุงููุฑูุฒู (ุงูุนูู)
 * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 * 
 * ูุฐุง ูู ุงููุณูุท ุงูุขูู ุจูู ูููุน ุงูุนููุงุก ููููุน ุงูุนูุงู
 * 
 * ุงููุณุคูููุงุช:
 * 1. ุญูุงูุฉ ููุชุงุญ OpenAI API
 * 2. ุงูุชูุงุตู ูุน ุงูุฐูุงุก ุงูุงุตุทูุงุนู
 * 3. ุงุณุชูุจุงู ูุชุฎุฒูู ุงูุทูุจุงุช
 * 4. ุชูุฒูุน ุงูุจูุงูุงุช ูููููุนูู
 * 5. Rate Limiting ููุญูุงูุฉ ูู ุงูุฅุณุงุกุฉ
 * 6. ูุณุญ ุชููุงุฆู ููุทูุจุงุช ุงููุฏููุฉ
 * 
 * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 */

const express = require('express');
const cors = require('cors');
const rateLimit = require('express-rate-limit');

const app = express();
const PORT = process.env.PORT || 3000;

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ ุงูุฅุนุฏุงุฏุงุช ุงูุญุณุงุณุฉ (ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const OPENAI_API_KEY = process.env.OPENAI_API_KEY || 'YOUR_API_KEY_HERE';

// ุชุญุฐูุฑ ุฅุฐุง ูู ูุชู ุถุจุท ุงูููุชุงุญ
if (!OPENAI_API_KEY) {
    console.warn('โ๏ธ  ุชุญุฐูุฑ: ููุชุงุญ OpenAI ุบูุฑ ููุนุฏ! ุฃุถูู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ');
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ก๏ธ Middleware
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

// CORS - ุงูุณูุงุญ ูููุง ุงููููุนูู
app.use(cors({
    origin: '*', // ูู ุงูุฅูุชุงุฌ: ุญุฏุฏ ุงููุทุงูุงุช ุงููุณููุญุฉ
    methods: ['GET', 'POST', 'PATCH', 'DELETE'],
    allowedHeaders: ['Content-Type']
}));

app.use(express.json());

// Rate Limiting - ุญูุงูุฉ ูู ุงูุฅุณุงุกุฉ
const chatLimiter = rateLimit({
    windowMs: 60 * 1000, // ุฏูููุฉ ูุงุญุฏุฉ
    max: 20, // 20 ุทูุจ ูุญุฏ ุฃูุตู
    message: {
        success: false,
        error: 'ุงููุซูุฑ ูู ุงูุทูุจุงุช! ุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ุฏูููุฉ',
        errorCode: 'RATE_LIMIT_EXCEEDED'
    }
});

const ordersLimiter = rateLimit({
    windowMs: 60 * 1000,
    max: 60,
    message: { success: false, error: 'Rate limit exceeded' }
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ฆ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุคูุชุฉ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const db = {
    orders: [],
    counter: 1000,
    lastCleanup: new Date().toDateString()
};

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐งน ุชูุธูู ุชููุงุฆู ูููู
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function autoCleanup() {
    const today = new Date().toDateString();
    
    if (today !== db.lastCleanup) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        yesterday.setHours(0, 0, 0, 0);
        
        const before = db.orders.length;
        db.orders = db.orders.filter(o => new Date(o.createdAt) >= yesterday);
        
        if (before !== db.orders.length) {
            console.log(`๐งน ุชูุธูู ุชููุงุฆู: ุญุฐู ${before - db.orders.length} ุทูุจ ูุฏูู`);
        }
        db.lastCleanup = today;
    }
}

// ุชุดุบูู ุงูุชูุธูู ูู ุณุงุนุฉ
setInterval(autoCleanup, 60 * 60 * 1000);

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ค System Prompt ููุฐูุงุก ุงูุงุตุทูุงุนู
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const SYSTEM_PROMPT = `# ูููู ุทูุจุงุช ูุทุนู ููู ุงูุทุงุจูู

## ูููุชู
ุฃูุช ูุณุงุนุฏ ุทูุจุงุช ูุทุนู "ููู ุงูุทุงุจูู" ูู ุงูุนูุฒุฑูุฉ. ุชุณุชูุจู ุทูุจุงุช ุงูุฒุจุงุฆู ุจุงูููุฌุฉ ุงูููุณุทูููุฉ.

## ูุนูููุงุช ุงููุทุนู
- ุงูุงุณู: ููู ุงูุทุงุจูู
- ุงูุนููุงู: ุงูุนูุฒุฑูุฉ - ุฏูุงุฑ ูุงุฏู ุงููุงุฑ
- ุณุงุนุงุช ุงูุนูู: 8:00 ุตุจุงุญุงู - 2:00 ุจุนุฏ ููุชุตู ุงูููู (ููููุงู)
- ููุช ุงูุชุญุถูุฑ: 7-10 ุฏูููุฉ
- ุงูุชูุตูู: ูุชููุฑ ููุนูุฒุฑูุฉ ูุงูููุงุทู ุงููุฌุงูุฑุฉ
- ุงูุฏูุน: ูุงุด ุฃู ููุฒุง ุฏุงุฎู ุงููุญู ููุท

## ููุงุนุฏ ุงูุณููู
1. ุชุญุฏุซ ุจููุฌุฉ ููุณุทูููุฉ ุจุณูุทุฉ ููุฏูุฏุฉ
2. ูู ูุฎุชุตุฑุงู - ูุง ุชูุชุจ ุฑุณุงุฆู ุทูููุฉ
3. ูุง ุชุนุฑุถ ุงููุงุฆูุฉ ูุงููุฉ - ุงุนุฑุถ ููุท ุฎูุงุฑุงุช ุงูุตูู ุงููุทููุจ
4. ุงุณุชุฎุฏู ุฅูููุฌู ูุงุญุฏ ุฃู ุงุซููู ููุท
5. ูุง ุชุฎุชุฑุน ุฃุตูุงู ุบูุฑ ููุฌูุฏุฉ ููุง ุชุบูุฑ ุงูุฃุณุนุงุฑ
6. ุงุฌูุน: ุงูุงุณู + ุงูุทูุจ + ุงูููุงู (ุฏุงุฎู ุงููุญู ุฃู ุจุงูุณูุงุฑุฉ)

## ููู ุฌุฏุงู - ุชูุณูู ุงูุทูุจ ุงูููุงุฆู
ุนูุฏูุง ูุคูุฏ ุงูุฒุจูู ุทูุจู (ูููู "ูุนู" ุฃู "ุชุฃููุฏ" ุฃู ุฃู ููุงููุฉ)ุ ูุฌุจ ุฃู ุชุถูู ูู ููุงูุฉ ุฑุฏู ูุฐุง ุงูุชูุณูู ุจุงูุถุจุท:

[ORDER_DATA]
{"customer":"ุงุณู ุงูุฒุจูู","items":"ุงูุฃุตูุงู ุงููุทููุจุฉ","total":ุงููุจูุบ_ุฑูู,"location":"ุงูููุงู"}
[/ORDER_DATA]

ูุซุงู:
[ORDER_DATA]
{"customer":"ุฃุญูุฏ","items":"ุจูุชุฒุง ุงูุทุงุจููร2, ุจูุถ ูุน ุฌุจูุฉร1","total":55,"location":"ุฏุงุฎู ุงููุญู"}
[/ORDER_DATA]

## ุงููุงุฆูุฉ ุงููุงููุฉ

### ุงูุจูุชุฒุง
- ุจูุชุฒุง ุงูุทุงุจูู: 20 ุดููู
- ุจูุชุฒุง ุจุงูุฌุจูุฉ ุงูุจูุถุงุก: 23 ุดููู
- ุจูุชุฒุง ุชููุง: 25 ุดููู
- ุจูุชุฒุง ุณุชูู ุฏุฌุงุฌ: 30 ุดููู
- ุจูุชุฒุง ุณูุงูู: 25 ุดููู
- ุจูุชุฒุง ููุณ ุฌุจูุฉ: 22 ุดููู
- ุจูุชุฒุง ููุณููู ุญุงุฑ: 30 ุดููู
- ุจูุชุฒุง ููุงูู: 23 ุดููู
- ุจูุชุฒุง ุนููู ุฎุถุงุฑ: 25 ุดููู
- ุจูุชุฒุง ุนููู ุณุชูู: 35 ุดููู
- ุจูุชุฒุง ุนููู ุณูุงูู: 30 ุดููู
- ุจูุชุฒุง ุนููู ููุณููู: 35 ุดููู
- ุจูุชุฒุง ุนููู ููุงูู: 28 ุดููู

### ุงูุจูุถ
- ุจูุถ ุณุงุฏุฉ: 8 ุดููู
- ุจูุถ ูุน ุฌุจูุฉ ุจูุถุงุก: 15 ุดููู
- ุจูุถ ูุน ุฌุจูุฉ ุนููู: 21 ุดููู
- ุจูุถ ูุน ุฌุจูุฉ ููุฒุงุฑููุง: 14 ุดููู
- ุจูุถ ูุน ุฌุจูุฉ ูููุงูู: 17 ุดููู
- ุจูุถ ูุน ุฒูุชูู ูุฏุฑุฉ: 12 ุดููู
- ุจูุถ ูุน ุณุฌู: 20 ุดููู
- ุจูุถ ูุน ุณุฌู ูุฌุจูุฉ: 22 ุดููู
- ุจูุถ ูุน ุณุฌู ูุฌุจูุฉ ุนููู: 28 ุดููู
- ุจูุถ ูุน ุณุฌู ูุฌุจูุฉ ูููุงูู: 28 ุดููู
- ุจูุถ ูุน ุนููู ูููุงูู: 23 ุดููู
- ุจูุถ ูุน ูุญูุฉ ุจุงูุฌุจูุฉ: 25 ุดููู
- ุจูุถ ูุน ูุญูุฉ ุทุงุฒุฌุฉ: 20 ุดููู
- ุจูุถ ูุน ููุงูู: 13 ุดููู

### ุงูุฌุจูุฉ
- ุฌุจูุฉ ุจูุถุงุก ูุน ุจูุฏูุฑุฉ: 18 ุดููู
- ุฌุจูุฉ ุจูุถุงุก ูุน ุญุจุฉ ุงูุจุฑูุฉ: 15 ุดููู
- ุฌุจูุฉ ุจูุถุงุก ูุน ุฒุนุชุฑ ุฃุฎุถุฑ: 17 ุดููู
- ุฌุจูุฉ ุจูุถุงุก ูุน ุฒูุช ูุฒุนุชุฑ: 17 ุดููู
- ุฌุจูุฉ ุจูุถุงุก ูุน ุฒูุชูู ุฃุฎุถุฑ: 17 ุดููู
- ุฌุจูุฉ ุนููู: 23 ุดููู
- ุฌุจูุฉ ุนููู ูุน ุณุชูู ุฏุฌุงุฌ: 30 ุดููู
- ุฌุจูุฉ ุนููู ูุน ุณูุงูู: 28 ุดููู
- ุฌุจูุฉ ุนููู ูุน ููุงูู: 27 ุดููู
- ุฌุจูุฉ ููุฒุงุฑููุง: 18 ุดููู
- ุฌุจูุฉ ููุฒุงุฑููุง ุจุงูุฏุฌุงุฌ ุงูููุณููู ุงูุญุงุฑ: 28 ุดููู
- ุฌุจูุฉ ููุฒุงุฑููุง ูุน ุฒูุชูู ุฃุฎุถุฑ: 20 ุดููู
- ุฌุจูุฉ ููุฒุงุฑููุง ูุน ุณุชูู ุงูุฏุฌุงุฌ: 28 ุดููู
- ุฌุจูุฉ ููุฒุงุฑููุง ูุน ุณูุงูู: 25 ุดููู
- ุฌุจูุฉ ููุฒุงุฑููุง ูุน ููุงูู: 23 ุดููู

### ุงููุญูุฉ ูุงูุณููุญุฉ
- ุณููุญุฉ ุจุงูุจูุฏูุฑุฉ: 15 ุดููู
- ุณููุญุฉ ุจุงูุทุญูููุฉ: 15 ุดููู
- ุณููุญุฉ ููุณ: 15 ุดููู
- ูุงููุชุง ุฌุจูุฉ: 23 ุดููู
- ูุงููุชุง ุฏุฌุงุฌ: 23 ุดููู
- ูุจุฏุฉ ุฏุฌุงุฌ: 20 ุดููู
- ูุญูุฉ ุทุงุฒุฌุฉ: 25 ุดููู
- ูุณุญุจ ูุน ุฌุจูุฉ: 25 ุดููู
- ูุณุฎู ุฏุฌุงุฌ: 22 ุดููู

### ุงูุตูุงูู
- ุตูุงูู ูุจูุฑ (ุดูู): 30 ุดููู
- ุตูุงูู ูุจูุฑ ูุน ุฎุถุงุฑ: 40 ุดููู
- ุตูุงูู ูุณุท (ุดูู): 20 ุดููู
- ุตูุงูู ูุณุท ูุน ุฎุถุงุฑ: 30 ุดููู

### ุงูุฎุจุฒ ูุงูููุงููุด
- ุฎุจุฒ ุงูุทุงุจูู: 1.50 ุดููู
- ุฎุจุฒ ุดุฑุงู: 1 ุดููู
- ููุงููุด ุฒุนุชุฑ: 7 ุดููู
- 7 ุทุงุจูู: 10 ุดููู

### ุงููุนุฌูุงุช ุงูุตุบูุฑุฉ
- ุฌุจูุฉ ุจูุถุงุก ุตุบูุฑ: 5 ุดููู
- ุฌุจูุฉ ุจูุถุงุก ูุน ุฒุนุชุฑ ุตุบูุฑ: 7 ุดููู
- ุฌุจูุฉ ูุน ุฒูุชูู ุฃุฎุถุฑ ุตุบูุฑ: 6 ุดููู
- ุฌุจูุฉ ูุน ููุงูู ุตุบูุฑ: 7 ุดููู
- ุฑูุงูุฉ ูุญูุฉ: 8 ุดููู
- ุณุจุงูุฎ: 6 ุดููู
- ุนุฑุงูุณ: 8 ุดููู
- ููุฉ ูุณุฎู: 8 ุดููู
- ูุณุญุจ ุฏุฌุงุฌ: 10 ุดููู

### ุงูููุจูุงุช
- ุดููู ูุชูู: 3 ุดููู
- ุตูุต ูููู: 3 ุดููู
- ุนูุจุฉ ุจุงุฑุจููู: 3 ุดููู
- ุนูุจุฉ ุฒูุชูู: 2 ุดููู
- ุนูุจุฉ ููุช ุตุบูุฑ: 2 ุดููู
- ุนูุจุฉ ูุฎูู ุตุบูุฑ: 2 ุดููู
- ูููู ููุจูุณ ุตุบูุฑ: 2 ุดููู
- ูุต ุทุจู ุจูุถ: 10 ุดููู

### ุงููุดุฑูุจุงุช
- ูุงุก ุตุบูุฑ: 2 ุดููู
- ูุงุก ูุจูุฑ: 3 ุดููู
- ูุงุจู ุตุบูุฑ: 3 ุดููู
- ูุจู ุฃุจ: 3 ุดููู
- ุนุตูุฑ ุชุจูุฒููุง: 4 ุดููู
- ุตูุฏุง: 5 ุดููู
- ูุดุฑูุจ ุบุงุฒู 330: 3 ุดููู
- ูุดุฑูุจ ุบุงุฒู 1.25: 5 ุดููู
- BLUE: 5 ุดููู
- TASCO: 5 ุดููู
- XL: 5 ุดููู
- ุจุงูุงุฑูุง: 5 ุดููู

## ุงูุฑุฏูุฏ ุงูุฎุงุตุฉ
- ุงูุชูุตูู: "ูุชููุฑ ููุนูุฒุฑูุฉ ูุงูููุงุทู ุงููุฌุงูุฑุฉ"
- ุงูุฏูุน: "ูุงุด ุฃู ููุฒุง ุฏุงุฎู ุงููุญู"
- ุณุงุนุงุช ุงูุนูู: "ูู 8 ุงูุตุจุญ ูู 2 ุจุงููููุ ูู ููู"
- ุตูู ุบูุฑ ููุฌูุฏ: "ููุฃุณู ูุด ูุชููุฑุ ุจูุชุฑุญ ุนููู [ุจุฏูู]"`;

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ API ููุฐูุงุก ุงูุงุตุทูุงุนู (ูููููุน ุงูุฃูู - ุงูุนููุงุก)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

/**
 * POST /api/chat
 * ูุณุชูุจู ุฑุณุงุฆู ุงูุนููุงุก ููุฑุฏูุง ููุฐูุงุก ุงูุงุตุทูุงุนู
 */
app.post('/api/chat', chatLimiter, async (req, res) => {
    try {
        const { message, history } = req.body;

        if (!message || typeof message !== 'string') {
            return res.status(400).json({
                success: false,
                error: 'ุงูุฑุณุงูุฉ ูุทููุจุฉ'
            });
        }

        // ุจูุงุก ุงููุญุงุฏุซุฉ
        const messages = [
            { role: 'system', content: SYSTEM_PROMPT },
            ...(history || []).slice(-10).map(msg => ({
                role: msg.role === 'user' ? 'user' : 'assistant',
                content: msg.content
            })),
            { role: 'user', content: message }
        ];

        // ุงุณุชุฏุนุงุก OpenAI API
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENAI_API_KEY}`
            },
            body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: messages,
                max_tokens: 500,
                temperature: 0.7
            })
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            console.error('OpenAI Error:', error);
            
            if (response.status === 429) {
                return res.status(429).json({
                    success: false,
                    reply: 'ุงูุฎุฏูุฉ ูุดุบููุฉ ุญุงููุงูุ ุญุงูู ูุฑุฉ ุฃุฎุฑู',
                    error: 'RATE_LIMIT'
                });
            }
            
            throw new Error('OpenAI API Error');
        }

        const data = await response.json();
        let reply = data.choices[0].message.content;

        // ุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ุงูุทูุจ ุฅุฐุง ูุฌุฏุช
        const orderMatch = reply.match(/\[ORDER_DATA\]([\s\S]*?)\[\/ORDER_DATA\]/);
        let orderId = null;

        if (orderMatch) {
            try {
                const orderData = JSON.parse(orderMatch[1].trim());
                
                // ุฅูุดุงุก ุงูุทูุจ
                const order = {
                    id: ++db.counter,
                    customerName: orderData.customer || 'ุนููู',
                    items: orderData.items || '',
                    total: parseFloat(orderData.total) || 0,
                    location: orderData.location || 'ุบูุฑ ูุญุฏุฏ',
                    status: 'new',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    source: 'AI_Chat'
                };

                db.orders.unshift(order);
                orderId = order.id;

                console.log(`\n๐ ุทูุจ ุฌุฏูุฏ #${order.id}`);
                console.log(`   ๐ค ${order.customerName}`);
                console.log(`   ๐ ${order.items}`);
                console.log(`   ๐ฐ ${order.total} ุดููู`);
                console.log(`   ๐ ${order.location}\n`);

                // ุฅุฒุงูุฉ ุจูุงูุงุช ุงูุทูุจ ูู ุงูุฑุฏ ูุฅุถุงูุฉ ุฑูู ุงูุทูุจ
                reply = reply.replace(/\[ORDER_DATA\][\s\S]*?\[\/ORDER_DATA\]/, '').trim();
                reply += `\n\n๐ ุฑูู ุทูุจู: #${orderId}`;

            } catch (e) {
                console.error('Error parsing order:', e);
            }
        }

        res.json({
            success: true,
            reply: reply,
            orderId: orderId
        });

    } catch (error) {
        console.error('Chat Error:', error);
        res.status(500).json({
            success: false,
            reply: 'ุนุฐุฑุงูุ ุญุตู ุฎุทุฃ. ุชูุงุตู ูุนูุง ุนูู ูุงุชุณุงุจ 0523668131',
            error: 'SERVER_ERROR'
        });
    }
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ฆ API ููุทูุจุงุช (ูููููุน ุงูุซุงูู - ุงูุนูุงู)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

/**
 * GET /api/orders
 * ุฌูุจ ุฌููุน ุงูุทูุจุงุช
 */
app.get('/api/orders', ordersLimiter, (req, res) => {
    autoCleanup();
    
    const { status } = req.query;
    let orders = [...db.orders];
    
    if (status && status !== 'all') {
        orders = orders.filter(o => o.status === status);
    }
    
    res.json({
        success: true,
        count: orders.length,
        orders: orders
    });
});

/**
 * POST /api/orders
 * ุฅูุดุงุก ุทูุจ ูุฏูู (ููุทูุจุงุช ุงููุงุชููุฉ)
 */
app.post('/api/orders', ordersLimiter, (req, res) => {
    const { customerName, items, total, location, notes } = req.body;
    
    if (!customerName || !items) {
        return res.status(400).json({
            success: false,
            error: 'ุงูุงุณู ูุงูุทูุจ ูุทููุจุงู'
        });
    }

    const order = {
        id: ++db.counter,
        customerName: customerName.trim(),
        items: items.trim(),
        total: parseFloat(total) || 0,
        location: location || 'ุบูุฑ ูุญุฏุฏ',
        notes: notes || '',
        status: 'new',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        source: 'Manual'
    };

    db.orders.unshift(order);

    console.log(`๐ ุทูุจ ูุฏูู ุฌุฏูุฏ #${order.id}`);

    res.status(201).json({
        success: true,
        message: 'ุชู ุฅูุดุงุก ุงูุทูุจ',
        order: order
    });
});

/**
 * GET /api/orders/:id
 * ุฌูุจ ุทูุจ ูุญุฏุฏ
 */
app.get('/api/orders/:id', (req, res) => {
    const order = db.orders.find(o => o.id === parseInt(req.params.id));
    
    if (!order) {
        return res.status(404).json({
            success: false,
            error: 'ุงูุทูุจ ุบูุฑ ููุฌูุฏ'
        });
    }
    
    res.json({ success: true, order });
});

/**
 * PATCH /api/orders/:id
 * ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
 */
app.patch('/api/orders/:id', (req, res) => {
    const { status, notes } = req.body;
    const order = db.orders.find(o => o.id === parseInt(req.params.id));
    
    if (!order) {
        return res.status(404).json({
            success: false,
            error: 'ุงูุทูุจ ุบูุฑ ููุฌูุฏ'
        });
    }

    const validStatuses = ['new', 'preparing', 'ready', 'delivered', 'cancelled'];
    
    if (status) {
        if (!validStatuses.includes(status)) {
            return res.status(400).json({
                success: false,
                error: 'ุญุงูุฉ ุบูุฑ ุตุงูุญุฉ'
            });
        }
        order.status = status;
        console.log(`๐ ุชุญุฏูุซ #${order.id}: ${status}`);
    }
    
    if (notes !== undefined) {
        order.notes = notes;
    }
    
    order.updatedAt = new Date().toISOString();

    res.json({ success: true, order });
});

/**
 * DELETE /api/orders/:id
 * ุญุฐู ุทูุจ
 */
app.delete('/api/orders/:id', (req, res) => {
    const index = db.orders.findIndex(o => o.id === parseInt(req.params.id));
    
    if (index === -1) {
        return res.status(404).json({
            success: false,
            error: 'ุงูุทูุจ ุบูุฑ ููุฌูุฏ'
        });
    }
    
    const deleted = db.orders.splice(index, 1)[0];
    console.log(`๐๏ธ ุญุฐู #${deleted.id}`);
    
    res.json({ success: true, message: 'ุชู ุญุฐู ุงูุทูุจ' });
});

/**
 * GET /api/stats
 * ุฅุญุตุงุฆูุงุช ุงูุทูุจุงุช
 */
app.get('/api/stats', (req, res) => {
    autoCleanup();
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayOrders = db.orders.filter(o => new Date(o.createdAt) >= today);
    
    res.json({
        success: true,
        stats: {
            total: db.orders.length,
            today: todayOrders.length,
            todayRevenue: todayOrders.reduce((sum, o) => sum + o.total, 0),
            byStatus: {
                new: db.orders.filter(o => o.status === 'new').length,
                preparing: db.orders.filter(o => o.status === 'preparing').length,
                ready: db.orders.filter(o => o.status === 'ready').length,
                delivered: db.orders.filter(o => o.status === 'delivered').length,
                cancelled: db.orders.filter(o => o.status === 'cancelled').length
            }
        }
    });
});

/**
 * GET /api/orders/poll
 * Long polling ููุชุญุฏูุซุงุช ุงูููุฑูุฉ
 */
let lastKnownId = 1000;
app.get('/api/orders/poll', (req, res) => {
    const since = parseInt(req.query.since) || lastKnownId;
    const newOrders = db.orders.filter(o => o.id > since);
    
    if (newOrders.length > 0) {
        lastKnownId = Math.max(...newOrders.map(o => o.id));
        res.json({ 
            hasUpdates: true, 
            orders: newOrders,
            lastId: lastKnownId 
        });
    } else {
        setTimeout(() => {
            res.json({ hasUpdates: false, lastId: since });
        }, 1000);
    }
});

/**
 * GET /api/health
 * ูุญุต ุตุญุฉ ุงูุณูุฑูุฑ
 */
app.get('/api/health', (req, res) => {
    res.json({
        status: 'ok',
        server: 'ููู ุงูุทุงุจูู - Backend',
        version: '2.0.0',
        orders: db.orders.length,
        uptime: Math.floor(process.uptime()) + ' ุซุงููุฉ'
    });
});

/**
 * DELETE /api/cleanup
 * ูุณุญ ุฌููุน ุงูุทูุจุงุช (ููุชุทููุฑ ููุท)
 */
app.delete('/api/cleanup', (req, res) => {
    const count = db.orders.length;
    db.orders = [];
    db.counter = 1000;
    console.log(`๐งน ุชู ูุณุญ ${count} ุทูุจ`);
    res.json({ success: true, message: `ุชู ูุณุญ ${count} ุทูุจ` });
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ ุชุดุบูู ุงูุณูุฑูุฑ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

app.listen(PORT, () => {
    console.log(`
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                           โ
โ   ๐ฅ  ููู ุงูุทุงุจูู - Backend ุงููุฑูุฒู                                      โ
โ                                                                           โ
โ   ๐ก ุงูุณูุฑูุฑ ูุนูู ุนูู: http://localhost:${PORT}                             โ
โ                                                                           โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                           โ
โ   ๐ APIs ูููููุน ุงูุฃูู (ุงูุนููุงุก):                                         โ
โ      POST /api/chat         โ ูุญุงุฏุซุฉ ูุน ุงูุฐูุงุก ุงูุงุตุทูุงุนู                  โ
โ                                                                           โ
โ   ๐ฆ APIs ูููููุน ุงูุซุงูู (ุงูุนูุงู):                                         โ
โ      GET  /api/orders       โ ุฌูุจ ูู ุงูุทูุจุงุช                              โ
โ      POST /api/orders       โ ุฅูุดุงุก ุทูุจ ูุฏูู                              โ
โ      PATCH /api/orders/:id  โ ุชุญุฏูุซ ุญุงูุฉ ุทูุจ                              โ
โ      DELETE /api/orders/:id โ ุญุฐู ุทูุจ                                     โ
โ      GET  /api/stats        โ ุงูุฅุญุตุงุฆูุงุช                                  โ
โ      GET  /api/orders/poll  โ ุชุญุฏูุซุงุช ููุฑูุฉ                               โ
โ                                                                           โ
โ   โค๏ธ  GET /api/health        โ ูุญุต ุตุญุฉ ุงูุณูุฑูุฑ                             โ
โ                                                                           โ
โ   ุฌุงูุฒ ูุฎุฏูุฉ ุงููููุนูู! ๐                                                 โ
โ                                                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    `);
});

module.exports = app;
